<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repository Analyzer</title>
    <link rel="stylesheet" href="/style.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div class="main-layout">
        <!-- Left Side - Analysis Progress -->
        <div class="progress-sidebar">
            <div class="progress-header">
                <h3>üîÑ Analysis Progress</h3>
                <button onclick="clearProgress()" class="clear-btn">Clear</button>
            </div>
            <div id="progressMessages" class="progress-messages"></div>
        </div>

        <!-- Middle - Main Content -->
        <div class="main-content">
            <div class="container">
                <h1>Repository Analyzer</h1>
                
                <form id="analyzeForm">
                    <div class="form-group">
                        <label for="repoUrl">Repository URL:</label>
                        <input type="text" id="repoUrl" name="repoUrl" placeholder="https://github.com/username/repository" required>
                    </div>
                    <button type="submit">Analyze Repository</button>
                </form>

                <div style="margin: 20px 0;">
                    <button onclick="testConnection()" style="background-color: #6c757d; margin-right: 10px;">Test Connection</button>
                    <button onclick="testAnalyze()" style="background-color: #17a2b8;">Test Analyze Route</button>
                </div>

                <div id="result"></div>
            </div>
        </div>

        <!-- Right Side - AI Chat -->
        <div class="chat-sidebar">
            <div class="chat-header">
                <h3>ü§ñ AI Assistant</h3>
                <button onclick="clearChat()" class="clear-btn">Clear Chat</button>
            </div>
            <div id="chatMessages" class="chat-messages"></div>
            <div class="chat-input-container">
                <input type="text" id="chatInput" placeholder="Ask me anything about Docker, deployment, or your repository..." class="chat-input">
                <button onclick="sendChatMessage()" class="chat-send-btn">Send</button>
            </div>
        </div>
    </div>

    <script>
        let currentAnalysisId = null;
        let socket = null;

        // Initialize Socket.IO connection
        function initializeSocket() {
            socket = io();
            
            socket.on('connect', () => {
                console.log('Connected to server');
                addProgressMessage('Connected to server', 'info');
            });
            
            socket.on('disconnect', () => {
                console.log('Disconnected from server');
                addProgressMessage('Disconnected from server', 'error');
            });
            
            socket.on('progress', (data) => {
                addProgressMessage(data.message, data.type);
            });
        }

        // Add progress message to chat
        function addProgressMessage(message, type = 'info') {
            const progressMessages = document.getElementById('progressMessages');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `progress-message ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            messageDiv.innerHTML = `
                <div class="message-content">
                    <span class="message-text">${message}</span>
                    <span class="message-time">${timestamp}</span>
                </div>
            `;
            
            progressMessages.appendChild(messageDiv);
            progressMessages.scrollTop = progressMessages.scrollHeight;
        }

        // Clear progress messages
        function clearProgress() {
            const progressMessages = document.getElementById('progressMessages');
            progressMessages.innerHTML = '';
        }

        // Clear chat messages
        function clearChat() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
        }

        // Initialize socket when page loads
        document.addEventListener('DOMContentLoaded', initializeSocket);

        document.getElementById('analyzeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const repoUrl = document.getElementById('repoUrl').value;
            const resultDiv = document.getElementById('result');
            
            // Clear previous results and show progress
            resultDiv.innerHTML = '';
            clearProgress();
            addProgressMessage('üöÄ Starting analysis...', 'info');
            
            // Show loading state
            resultDiv.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Analyzing repository...</p>
                </div>
            `;
            
            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ repoUrl })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentAnalysisId = data.analysisId;
                    addProgressMessage('‚úÖ Analysis completed successfully!', 'success');
                    displayResults(data);
                } else {
                    addProgressMessage(`‚ùå Error: ${data.message}`, 'error');
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h3>Error</h3>
                            <p>${data.message}</p>
                        </div>
                    `;
                }
            } catch (error) {
                addProgressMessage(`‚ùå Failed to analyze repository: ${error.message}`, 'error');
                resultDiv.innerHTML = `
                    <div class="error">
                        <h3>Error</h3>
                        <p>Failed to analyze repository: ${error.message}</p>
                    </div>
                `;
            }
        });

        function displayResults(data) {
            const resultDiv = document.getElementById('result');
            
            let html = `
                <div class="analysis-section">
                    <h3>Analysis Summary</h3>
                    <div class="analysis-summary">
                        <div class="summary-card">
                            <h3>Files Found</h3>
                            <div class="value">${data.analysis.totalFiles}</div>
                            <div class="label">Total files in repository</div>
                        </div>
                        <div class="summary-card">
                            <h3>Dockerfile</h3>
                            <div class="value">${data.analysis.dockerfile.exists ? '‚úÖ' : '‚ùå'}</div>
                            <div class="label">${data.analysis.dockerfile.exists ? 'Found' : 'Missing'}</div>
                            ${data.generated.dockerfile ? '<div class="generated-badge">Generated</div>' : ''}
                        </div>
                        <div class="summary-card">
                            <h3>Docker Compose</h3>
                            <div class="value">${data.analysis.compose.exists ? '‚úÖ' : '‚ùå'}</div>
                            <div class="label">${data.analysis.compose.exists ? 'Found' : 'Missing'}</div>
                            ${data.generated.compose ? '<div class="generated-badge">Generated</div>' : ''}
                        </div>
                        <div class="summary-card">
                            <h3>README</h3>
                            <div class="value">${data.analysis.readme.exists ? '‚úÖ' : '‚ùå'}</div>
                            <div class="label">${data.analysis.readme.exists ? 'Found' : 'Missing'}</div>
                            ${data.generated.readme ? '<div class="generated-badge">Generated</div>' : ''}
                        </div>
                    </div>
                </div>
            `;

            // Add download all button
            html += `
                <div class="download-section">
                    <h3>Download Files</h3>
                    <div class="download-buttons">
                        <button class="download-btn download-all-btn" onclick="downloadAllFiles()">
                            üì¶ Download All Files (ZIP)
                        </button>
                    </div>
                </div>
            `;

            // Display issues if any
            if (data.issues && data.issues.length > 0) {
                html += `
                    <div class="analysis-section">
                        <h3>Issues & Recommendations</h3>
                        <ul class="issues-list">
                `;
                
                data.issues.forEach(issue => {
                    const severityClass = `severity-${issue.severity}`;
                    const issueClass = `issue-${issue.type}`;
                    
                    html += `
                        <li class="issue-item ${issueClass}">
                            <div class="issue-header">
                                <h4 class="issue-title">${issue.title}</h4>
                                <span class="issue-severity ${severityClass}">${issue.severity}</span>
                            </div>
                            <p>${issue.message}</p>
                        </li>
                    `;
                });
                
                html += `
                        </ul>
                    </div>
                `;
            }

            // Display file contents
            html += `
                <div class="analysis-section">
                    <h3>File Contents</h3>
            `;

            if (data.files.dockerfile) {
                html += `
                    <div class="file-section">
                        <div class="file-header">
                            <span>Dockerfile</span>
                            <div class="file-actions">
                                <span class="file-status">${data.generated.dockerfile ? 'Generated' : 'Existing'}</span>
                                <button class="download-btn" onclick="downloadFile('dockerfile')">
                                    üíæ Download
                                </button>
                            </div>
                        </div>
                        <div class="file-content">
                            <pre>${escapeHtml(data.files.dockerfile)}</pre>
                        </div>
                    </div>
                `;
            }

            if (data.files.compose) {
                html += `
                    <div class="file-section">
                        <div class="file-header">
                            <span>docker-compose.yml</span>
                            <div class="file-actions">
                                <span class="file-status">${data.generated.compose ? 'Generated' : 'Existing'}</span>
                                <button class="download-btn" onclick="downloadFile('compose')">
                                    üíæ Download
                                </button>
                            </div>
                        </div>
                        <div class="file-content">
                            <pre>${escapeHtml(data.files.compose)}</pre>
                        </div>
                    </div>
                `;
            }

            if (data.files.readme) {
                html += `
                    <div class="file-section">
                        <div class="file-header">
                            <span>README.md</span>
                            <div class="file-actions">
                                <span class="file-status">${data.generated.readme ? 'Generated' : 'Existing'}</span>
                                <button class="download-btn" onclick="downloadFile('readme')">
                                    üíæ Download
                                </button>
                            </div>
                        </div>
                        <div class="file-content">
                            <pre>${escapeHtml(data.files.readme)}</pre>
                        </div>
                    </div>
                `;
            }

            html += `
                </div>
            `;

            resultDiv.innerHTML = html;
        }

        function downloadFile(fileType) {
            if (!currentAnalysisId) {
                alert('No analysis available for download');
                return;
            }
            
            const url = `/download/${fileType}/${currentAnalysisId}`;
            const link = document.createElement('a');
            link.href = url;
            link.download = '';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function downloadAllFiles() {
            if (!currentAnalysisId) {
                alert('No analysis available for download');
                return;
            }
            
            const url = `/download-all/${currentAnalysisId}`;
            const link = document.createElement('a');
            link.href = url;
            link.download = '';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function testConnection() {
            const resultDiv = document.getElementById('result');
            try {
                const response = await fetch('/test');
                const data = await response.json();
                resultDiv.innerHTML = `
                    <div class="analysis-section">
                        <h3>Connection Test Result</h3>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h3>Connection Test Failed</h3>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        async function testAnalyze() {
            const resultDiv = document.getElementById('result');
            try {
                const response = await fetch('/test-analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ test: true })
                });
                const data = await response.json();
                resultDiv.innerHTML = `
                    <div class="analysis-section">
                        <h3>Analyze Route Test Result</h3>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h3>Analyze Route Test Failed</h3>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Chat functionality
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const messages = document.getElementById('chatMessages');
            const message = input.value.trim();

            if (!message) return;

            // Add user message
            addChatMessage('You', message, 'user');
            input.value = '';

            // Show loading indicator
            const loadingId = addChatMessage('AI', 'Thinking...', 'bot', 'loading');

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message })
                });

                const data = await response.json();

                // Remove loading message
                const loadingElement = document.getElementById(loadingId);
                if (loadingElement) {
                    loadingElement.remove();
                }

                if (data.success) {
                    addChatMessage('AI', data.reply, 'bot');
                } else {
                    addChatMessage('AI', `Error: ${data.message || data.error}`, 'bot', 'error');
                }
            } catch (error) {
                // Remove loading message
                const loadingElement = document.getElementById(loadingId);
                if (loadingElement) {
                    loadingElement.remove();
                }
                addChatMessage('AI', `Error: ${error.message}`, 'bot', 'error');
            }
        }

        function addChatMessage(sender, message, type, status = '') {
            const messages = document.getElementById('chatMessages');
            const messageId = 'msg-' + Date.now();
            
            const messageDiv = document.createElement('div');
            messageDiv.id = messageId;
            messageDiv.className = `chat-message ${type} ${status}`;
            
            const timestamp = new Date().toLocaleTimeString();
            const senderClass = type === 'user' ? 'user' : '';
            
            // Format the message content for better display
            let formattedMessage = message;
            if (type === 'bot' && !status) {
                // Convert markdown-like formatting to HTML
                formattedMessage = formatMessage(message);
            }
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-sender ${senderClass}">${sender}</span>
                    <span class="message-time">${timestamp}</span>
                </div>
                <div class="message-content">${formattedMessage}</div>
            `;
            
            messages.appendChild(messageDiv);
            
            // Smooth scroll to bottom
            setTimeout(() => {
                messages.scrollTo({
                    top: messages.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
            
            return messageId;
        }

        function formatMessage(message) {
            // Convert markdown-like formatting to HTML
            return message
                // Headers
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                // Bold
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Italic
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Code blocks
                .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                // Inline code
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                // Lists
                .replace(/^\* (.*$)/gim, '<li>$1</li>')
                .replace(/^- (.*$)/gim, '<li>$1</li>')
                // Wrap lists in ul tags
                .replace(/(<li>.*<\/li>)/gim, '<ul>$1</ul>')
                // Line breaks
                .replace(/\n/g, '<br>')
                // Clean up multiple line breaks
                .replace(/<br><br>/g, '</p><p>')
                .replace(/^(.*)$/gim, '<p>$1</p>')
                // Clean up empty paragraphs
                .replace(/<p><\/p>/g, '')
                .replace(/<p><br><\/p>/g, '');
        }

        // Allow Enter key to send message
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });
    </script>
</body>
</html>
